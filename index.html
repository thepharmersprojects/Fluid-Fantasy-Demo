<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Oil Toy â€“ Thin Film Demo</title>
<style>
html,body{margin:0;height:100%;background:#0b1220;overflow:hidden;}
#stage{position:relative;width:100%;height:100%;}
.backplate{position:absolute;inset:20px;border-radius:14px;z-index:0;
  background:#c42529;box-shadow:0 0 0 1px rgba(0,0,0,.25) inset;}
canvas{position:absolute;inset:20px;border-radius:14px;width:calc(100%-40px);
  height:calc(100%-40px);z-index:1;}
.redsheet{position:absolute;inset:20px;border-radius:14px;z-index:3;
  background:rgba(215,30,30,.25);}
.frame{position:absolute;inset:0;border:10px solid rgba(255,255,255,.15);
  border-radius:24px;pointer-events:none;z-index:4;}
#hud{position:absolute;left:10px;bottom:10px;padding:6px 8px;
  background:rgba(0,0,0,.5);color:#fff;font:12px system-ui;border-radius:6px;}
button{position:absolute;left:10px;top:10px;z-index:10;}
</style>
</head>
<body>
<button id="enableTilt">Enable Motion</button>
<div id="stage">
  <div class="backplate"></div>
  <canvas id="c"></canvas>
  <div class="redsheet"></div>
  <div class="frame"></div>
  <div id="hud"></div>
</div>

<script>
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H;function resize(){W=canvas.width=innerWidth-40;H=canvas.height=innerHeight-40;}
addEventListener("resize",resize);resize();

//--- motion ---
let gravity={x:0,y:1};let enabled=false;
document.getElementById("enableTilt").onclick=()=>{
  if(typeof DeviceMotionEvent!=="undefined"&&DeviceMotionEvent.requestPermission){
    DeviceMotionEvent.requestPermission().then(p=>{
      if(p==="granted"){enabled=true;}
    });
  }else{enabled=true;}
};

//--- constants ---
const OIL="#2a8cff",EDGE="rgba(0,0,0,0.9)";
const MASS_TOTAL=800;let massTop=MASS_TOTAL,massDrops=0;
const GRAVITY_SCALE=0.12,VISCOSITY=0.75;
const DRIP_TILT_ON=14,DRIP_TILT_OFF=9;let meniscusPinned=true;
let drops=[],dropAccumulator=0;

//--- motion listener ---
window.addEventListener("deviceorientation",e=>{
  if(!enabled)return;
  const gx=Math.sin(e.gamma*Math.PI/180);
  const gy=Math.sin(e.beta*Math.PI/180);
  gravity.x=gx;gravity.y=gy;
});

//--- helpers ---
function gUnit(){const m=Math.hypot(gravity.x,gravity.y)||1;return{x:gravity.x/m,y:gravity.y/m};}
function areaFromMass(m){return m;}
function radiiFromArea(A,elong=1){const rx=Math.sqrt(A/(Math.PI*elong));return{rx,ry:rx*elong};}
function drawTearDrop(ctx,d){
  const {gx,gy}=gUnit(),px=-gy,py=gx;
  const tail=Math.min(d.ry*0.9,12);
  const noseX=d.x+gx*(d.ry+tail),noseY=d.y+gy*(d.ry+tail);
  const buttX=d.x-gx*d.ry,buttY=d.y-gy*d.ry;
  ctx.beginPath();
  ctx.moveTo(buttX+px*d.rx,buttY+py*d.rx);
  ctx.quadraticCurveTo(d.x+px*d.rx,d.y+py*d.rx,noseX,noseY);
  ctx.quadraticCurveTo(d.x-px*d.rx,d.y-py*d.rx,buttX-px*d.rx,buttY-py*d.rx);
  ctx.closePath();ctx.fillStyle=OIL;ctx.strokeStyle=EDGE;ctx.lineWidth=1.5;ctx.fill();ctx.stroke();
}

//--- emit drip ---
function emitDrop(dt){
  const tilt=Math.abs(Math.asin(gravity.x))*180/Math.PI;
  if(meniscusPinned&&tilt>DRIP_TILT_ON)meniscusPinned=false;
  if(!meniscusPinned&&tilt<DRIP_TILT_OFF)meniscusPinned=true;
  if(meniscusPinned)return;
  dropAccumulator+=dt*6;
  if(dropAccumulator>=1&&massTop>0){
    dropAccumulator-=1;
    const m=8;massTop-=m;massDrops+=m;
    const {gx,gy}=gUnit(),A=areaFromMass(m);
    const elong=1.4;const {rx,ry}=radiiFromArea(A,elong);
    drops.push({x:W/2,y:H*0.2,vx:gx*0.2,vy:gy*0.2,rx,ry,m});
  }
}

//--- physics ---
function step(dt){
  emitDrop(dt);
  const {gx,gy}=gUnit();
  for(let i=drops.length-1;i>=0;i--){
    const d=drops[i];
    d.vx=(d.vx+gx*GRAVITY_SCALE)* (1-VISCOSITY*dt);
    d.vy=(d.vy+gy*GRAVITY_SCALE)* (1-VISCOSITY*dt);
    d.x+=d.vx*dt*60;d.y+=d.vy*dt*60;
    if(d.y>H-30){
      // merge into pool
      massDrops-=d.m;massTop+=d.m;drops.splice(i,1);
    }
  }
}

//--- draw ---
function draw(){
  ctx.clearRect(0,0,W,H);
  // bottom pool
  const poolH=Math.max(20,massTop/40);
  ctx.fillStyle=OIL;ctx.strokeStyle=EDGE;ctx.lineWidth=2;
  ctx.beginPath();
  ctx.roundRect(W*0.2,H-poolH,W*0.6,poolH,10);
  ctx.fill();ctx.stroke();
  // drops
  for(const d of drops)drawTearDrop(ctx,d);
  document.getElementById("hud").textContent=
    `Top:${massTop.toFixed(0)} Drops:${massDrops.toFixed(0)} Total:${(massTop+massDrops).toFixed(0)}`;
}

//--- loop ---
let last=performance.now();
function loop(now){
  const dt=Math.min(0.05,(now-last)/1000);last=now;
  step(dt);draw();requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
